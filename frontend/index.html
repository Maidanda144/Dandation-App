<!DOCTYPE html>
<html lang="fr" class="antialiased">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Attendance Dashboard â€” CSP/HIKIMA</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root { --card-shadow: 0 10px 30px rgba(2,6,23,0.08); }
  html,body { font-family: 'Poppins', sans-serif; }
  .btn { @apply px-3 py-2 rounded-md font-semibold shadow-sm; }
  .att-btn { padding: 6px 10px; border-radius: 6px; font-weight:600; }
</style>
</head>
<body class="bg-gray-100 text-gray-900 dark:bg-gray-900 dark:text-gray-100">

<script>
  // âœ… DÃ©finir l'URL de l'API
  const API_URL = 'https://hikima-goi8.onrender.com/api';
</script>

<!-- ===== LOGIN SCREEN ===== -->
<div id="login-screen" class="min-h-screen flex items-center justify-center p-6">
  <div class="w-full max-w-md bg-white dark:bg-gray-800 rounded-2xl p-8 shadow" style="box-shadow: var(--card-shadow)">
    <h2 class="text-2xl font-bold mb-2 text-center">Connexion</h2>
    <p class="text-sm text-gray-500 mb-6 text-center">Connecte-toi pour accÃ©der au dashboard</p>
    <div class="space-y-3">
      <input id="username" class="w-full p-3 rounded-md border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900" placeholder="Nom d'utilisateur">
      <input id="password" type="password" class="w-full p-3 rounded-md border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900" placeholder="Mot de passe">
      <div class="flex items-center justify-between">
        <button id="login-btn" class="bg-gradient-to-r from-indigo-600 to-indigo-400 text-white px-5 py-2 rounded-md font-semibold">Se connecter</button>
        <button id="demo-btn" class="text-sm text-gray-600 dark:text-gray-300">Demo: admin / 1234</button>
      </div>
      <p id="login-error" class="text-red-500 text-sm mt-2"></p>
    </div>
  </div>
</div>

<!-- ===== MAIN APP ===== -->
<div id="app" class="hidden h-screen flex overflow-hidden">
  <!-- SIDEBAR -->
  <aside id="sidebar" class="w-64 bg-white dark:bg-gray-800 p-6 border-r border-gray-200 dark:border-gray-700">
    <div class="flex items-center gap-3 mb-6">
      <div class="w-12 h-12 rounded-full bg-indigo-600 flex items-center justify-center text-white font-bold">M</div>
      <div>
        <div class="text-lg font-semibold">Admin</div>
        <div class="text-xs text-gray-500 dark:text-gray-400">Administrateur</div>
      </div>
    </div>
    <nav class="space-y-2 mt-4">
      <button class="w-full text-left p-3 rounded-md hover:bg-indigo-50 dark:hover:bg-indigo-700 flex items-center gap-3" onclick="showSection('overview')"><span>ğŸ </span><span>Accueil</span></button>
      <button class="w-full text-left p-3 rounded-md hover:bg-indigo-50 dark:hover:bg-indigo-700 flex items-center gap-3" onclick="showSection('classes')"><span>ğŸ§‘â€ğŸ«</span><span>Classes</span></button>
      <button class="w-full text-left p-3 rounded-md hover:bg-indigo-50 dark:hover:bg-indigo-700 flex items-center gap-3" onclick="showSection('students')"><span>ğŸ“š</span><span>Ã‰tudiants</span></button>
      <button class="w-full text-left p-3 rounded-md hover:bg-indigo-50 dark:hover:bg-indigo-700 flex items-center gap-3" onclick="logout()"><span>ğŸšª</span><span>DÃ©connexion</span></button>
    </nav>
    <div class="mt-8">
      <button id="dark-toggle" class="w-full py-2 px-3 rounded-md bg-gray-200 dark:bg-gray-700" onclick="toggleDarkMode()">ğŸŒ“ Basculer thÃ¨me</button>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <div class="flex-1 flex flex-col">
    <header class="flex items-center justify-between px-6 py-4 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
      <div class="flex items-center gap-4">
        <h1 class="text-xl font-bold">Dashboard</h1>
        <div id="student-count" class="ml-6 text-sm text-gray-500 dark:text-gray-300">Ã‰tudiants: 0</div>
      </div>
      <div class="flex items-center gap-3">
        <input id="global-search" type="search" placeholder="Rechercher un Ã©tudiant..." class="px-3 py-2 rounded-md border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900" oninput="searchAll(this.value)">
        <button class="px-3 py-2 rounded-md bg-amber-500 text-white" onclick="exportCSV()">Exporter CSV</button>
      </div>
    </header>

    <main class="p-6 overflow-auto flex-1 bg-gray-50 dark:bg-gray-900">
      <!-- OVERVIEW -->
      <section id="overview" class="">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
          <div class="p-6 bg-white dark:bg-gray-800 rounded-xl shadow">
            <h3 class="font-semibold text-gray-500 dark:text-gray-300">Total Ã©tudiants</h3>
            <div id="total-students" class="text-3xl font-bold mt-2">0</div>
          </div>
          <div class="p-6 bg-white dark:bg-gray-800 rounded-xl shadow">
            <h3 class="font-semibold text-gray-500 dark:text-gray-300">PrÃ©sences aujourd'hui</h3>
            <div id="today-present" class="text-3xl font-bold mt-2">0</div>
          </div>
          <div class="p-6 bg-white dark:bg-gray-800 rounded-xl shadow">
            <h3 class="font-semibold text-gray-500 dark:text-gray-300">Classes actives</h3>
            <div id="active-classes" class="text-3xl font-bold mt-2">0</div>
          </div>
        </div>
      </section>

      <!-- CLASSES -->
      <section id="classes" class="hidden">
        <h2 class="text-2xl font-bold mb-4">Classes</h2>
        <div id="class-buttons" class="flex flex-wrap gap-3 mb-6"></div>
        <div id="lists-container" class="space-y-4"></div>
      </section>

      <!-- STUDENTS -->
      <section id="students" class="hidden">
        <h2 class="text-2xl font-bold mb-4">Ã‰tudiants (All)</h2>
        <div id="students-table" class="bg-white dark:bg-gray-800 rounded-xl shadow p-4"></div>
      </section>
    </main>
  </div>
</div>

<script>
/* ---------------- DATA ---------------- */
const classesData = {
  'TA1': ['Farida', 'Imane', 'Latifa'],
  'TA2': ['Mahamadou', 'Hajara', 'Halima'],
  'TA3': ['Fatima', 'Farouk', 'Nazifi'],
  'TD1': ['Leyla', 'Hadiza', 'Ismael'],
  'TD2': ['Achirou', 'Nouradine', 'Rafiatou'],
  'TD3': ['Mariama', 'Salamatou', 'Issa', 'Abdoulaye']
};
let attendance = {};
let openClass = null;

/* --------------- LOGIN ---------------- */
document.getElementById('login-btn').addEventListener('click', doLogin);
document.getElementById('demo-btn').addEventListener('click', () => {
  document.getElementById('username').value = 'admin';
  document.getElementById('password').value = '1234';
});

async function doLogin() {
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value.trim();

  try {
    const res = await fetch(`${API_URL}/auth/login`, {  // <-- URL publique
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password })
    });

    if(res.ok){
      const data = await res.json();
      localStorage.setItem('token', data.token);
      document.getElementById('login-screen').classList.add('hidden');
      document.getElementById('app').classList.remove('hidden');
      initApp();
    } else {
      const err = await res.json();
      document.getElementById('login-error').textContent = err.message;
    }
  } catch(e){
    document.getElementById('login-error').textContent = 'Impossible de contacter le serveur';
    console.error(e);
  }
}

/* --------------- SEND SMS CLASS ---------------- */
function sendClassSMS(cls) {
  const students = classesData[cls];
  const messages = [];

  students.forEach(name => {
    if (attendance[name]) {
      messages.push({
        To: '+233534708025',
        Message: `${name} est ${attendance[name]}`
      });
    }
  });

  if (messages.length === 0) {
    alert('Aucun statut Ã  envoyer pour cette classe.');
    return;
  }

  const payload = { req: messages };

  fetch(`${API_URL}/sms/send`, {  // <-- URL publique
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  })
  .then(res => res.json())
  .then(data => {
    alert('RÃ©ponse du backend: ' + JSON.stringify(data));
  })
  .catch(err => {
    console.error(err);
    alert('Erreur lors de lâ€™envoi des SMS');
  });
}

// ...reste du JS (dark mode, navigation, counts, etc.) inchangÃ©
</script>
</body>
</html>
